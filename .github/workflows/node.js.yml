name: Build and Deploy Obsidian Plugin

on:
  push:
    # Only run deployment logic on 'main' branch pushes
    branches: [ "main" ]
  # We will remove 'pull_request' to prevent accidental pushes
  # to the main branch from a PR build.

jobs:
  build:
    runs-on: ubuntu-latest
    
    # Use a single, stable Node.js version for the build
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: '20.x' # A single, stable version is sufficient
        cache: 'npm'
        
    - name: Install Dependencies
      run: npm ci
      
    - name: Build Plugin Files
      run: npm run build # This command must generate your plugin files (main.js, manifest.json, styles.css)
      
    # ðŸŒŸ NEW STEP: Upload the files that need to be pushed
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: plugin-artifacts
        path: |
          main.js # Adjust these paths based on where your build command puts them
          manifest.json 
          styles.css
          # Add any other files you need to deploy

  # ðŸŒŸ NEW JOB: Deploy (Commit and Push) the built files
  deploy:
    runs-on: ubuntu-latest
    needs: build # This job will only run after 'build' succeeds

    steps:
    # ðŸŒŸ NEW STEP: Download the built files from the previous job
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        name: plugin-artifacts
        
    # Checkout the repository again to prepare for a commit
    # We use GITHUB_TOKEN to perform the commit/push
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }} # Uses the default token with write permissions

    # ðŸŒŸ NEW STEP: Auto-commit and push the changed files
    - name: Commit and Push Built Files
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ðŸ¤– CI: Deploy built files [skip ci]"
        branch: main # Push back to the main branch
        # The default commit author is usually fine, but can be customized

